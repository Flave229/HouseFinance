@using System.Globalization
@using System.Linq
@using System.Threading.Tasks
@model HouseFinance.Core.Bills.BillDetails
@{
    ViewBag.Title = "Details for " + Model.Name + " Bill";
}

<script type="text/javascript">
    function confirmSubmission(message) {
        confirm(message);
    }
</script>

<div class="jumbotron">
    <h2>@Model.Name Details</h2>
</div>

<div class="row">
    <div class="mainContentWrapper">
        <div style="float: right">
            <a href="@Url.Action("EditBill", "Finance", new {billId = @Model.Id})" class="btn btn-primary">Edit Bill</a>
            <div class="btn btn-danger" onclick="deleteBill('@Model.Id')">Delete Bill</div>
        </div>
        <table id="example" class="table" cellspacing="0" width="100%">
            <thead>
            <tr style="color: black">
                <th>Total Amount</th>
                <th>Amount Paid</th>
                <th>Due</th>
            </tr>
            </thead>
            <tfoot>
            <tr>
                <th>@Model.TotalAmount.ToString("C", new CultureInfo("en-GB"))</th>
                <th>
                    @Model.AmountPaid.ToString("C", new CultureInfo("en-GB"))
                </th>
                <th>@Model.FullDateDue.ToString("dd/MM/yyyy")</th>
            </tr>
            </tfoot>
        </table>
        <br/>
        @if (Model.Payments.Any())
        {
            <h4>Payments Made Towards This Bill: </h4>
            <table id="example" class="table table-striped table-bordered" cellspacing="0" width="100%">
                <thead>
                <tr>
                    <th>Person</th>
                    <th>Paid On</th>
                    <th>Amount</th>
                </tr>
                </thead>
                <tfoot>
                @foreach (var payment in Model.Payments)
                {
                    <tr>
                        <th>@payment.PersonName</th>
                        <th>@payment.DatePaid.ToString("dd/MM/yyyy")</th>
                        <th>@payment.Amount.ToString("C", new CultureInfo("en-GB"))</th>
                        <th style="width: 10%; text-align: right">
                            <a href="@Url.Action("EditPayment", "Finance", new {billId = Model.Id, paymentId = payment.Id})">
                                <img src="http://i.imgur.com/OJvwwyE.png" alt="Edit" height="20" width="20"/>
                            </a>
                            <a onclick="deletePayment('@payment.Id')">
                                <img src="http://i.imgur.com/ltfOB60.png" alt="Delete" height="20" width="20"/>
                            </a>
                        </th>
                    </tr>
                }
                </tfoot>
            </table>
        }
        <a href="@Url.Action("AddPayment", "Finance", new {billId = @Model.Id})" class="btn btn-primary" style="float: right">Add Payment</a>
    </div>
</div>

<script>
    var billDetailsUrl = '@Url.Action("BillDetails", "Finance")';

    function deleteBill(billId) {
        if (confirm('Are you sure you wish to delete this bill?')) {
            var deleteBillRequest = { "BillId": billId };

            $.ajax({
                url: '@Url.Action("DeleteBillV2", "Api")',
                contentType: "application/json",
                type: "DELETE",
                beforeSend: function(xhr) {
                    xhr.setRequestHeader('Authorization', 'D2DB7539-634F-47C4-818D-59AD03C592E3');
                },
                data: JSON.stringify(deleteBillRequest),
                success: function (response) {
                    window.top.location.href = "/home";
                }
            });
        }
    }

    function deletePayment(paymentId) {
        if (confirm('Are you sure you wish to delete this payment?')) {
            var deletePaymentRequest = {
                "PaymentId": paymentId
            }

            $.ajax({
                url: '@Url.Action("DeletePaymentV2", "Api")',
                contentType: "application/json",
                type: "DELETE",
                beforeSend: function(xhr) {
                    xhr.setRequestHeader('Authorization', 'D2DB7539-634F-47C4-818D-59AD03C592E3');
                },
                data: JSON.stringify(deletePaymentRequest),
                success: function(response) {
                    window.top.location.href = billDetailsUrl + "?billId=" + @Model.Id;
                }
            });
        }
    }
</script>